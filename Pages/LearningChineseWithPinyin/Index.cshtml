@page "{handler?}"
@model HomeHubApp.Pages.LearningChineseWithPinyin.IndexModel

@{
    ViewData["Title"] = "Learning Chinese with Pinyin";
}

<div class="text-center">
    <h1>Learning Chinese with Pinyin</h1>
    <p>
        Paste Chinese text below to generate pinyin-adorned output,
        or use <a href="/LearningChineseWithPinyin/Sample" class="sample-link">Sample Text</a>.
    </p>

    <form id="pinyinForm" method="post">
        <textarea asp-for="InputText" id="inputTextArea" rows="5" style="width:100%;max-width:100%;" placeholder="Paste Chinese text here..."></textarea>
        <br />
        <button type="submit">Generate Pinyin</button>
    </form>

    @if (!string.IsNullOrEmpty(Model.OutputText))
    {
        <h3>Text with Pinyin</h3>
        <pre style="font-family: monospace; 
                    white-space: pre-wrap; 
                    border: 1px solid #ccc; 
                    padding: 10px; 
                    max-width: 800px; 
                    margin: 0 auto; 
                    text-align: left;
                    font-size: 1.5rem;
                    line-height: 1.4;">
@Model.OutputText
        </pre>
    }
</div>

<style>
    .sample-link {
        color: #0066cc;
        text-decoration: underline;
        font-weight: 500;
    }

        .sample-link:hover {
            color: #003366;
            text-decoration: none;
        }
</style>

@section Scripts {
    <script>
        (function () {
            var lastSubmittedValue = '';
            var form = document.getElementById('pinyinForm');
            var textarea = document.getElementById('inputTextArea');
            var submitting = false;
            var inputTimeout = null;

            function checkAndSubmit() {
                if (submitting) return;
                var currentValue = textarea.value;
                if (currentValue !== lastSubmittedValue) {
                    submitting = true;
                    lastSubmittedValue = currentValue;
                    form.submit();
                }
            }

            // On initial page load, set lastSubmittedValue to the current value
            document.addEventListener('DOMContentLoaded', function () {
                lastSubmittedValue = textarea.value;
            });

            // After form submit, reset submitting flag
            form.addEventListener('submit', function () {
                submitting = false;
            });

            // Start 3-sec timer on input change.
            textarea.addEventListener('input', function () {
                if (inputTimeout) {
                    clearTimeout(inputTimeout);
                }
                inputTimeout = setTimeout(checkAndSubmit, 3000);
            });
        })();
    </script>
}